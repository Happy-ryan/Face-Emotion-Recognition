# Face-Emotion-Recognition

## **ğŸ’¡í”„ë¡œì íŠ¸ ìš”ì•½**
ì¸ê°„ì˜ ê°ì •ì„ êµ¬ë¶„í•˜ëŠ” ë”¥ëŸ¬ë‹ ëª¨ë¸ì„ AUìŠ¤ì½”ì–´ë¥¼ ì¶”ì¶œí•˜ê³  ë‹¤ì¤‘ ë¡œì§€ìŠ¤í‹± íšŒê·€ë¥¼ ì´ìš©í•˜ì—¬ ì„¤ëª…í•¨ìœ¼ì¨ ë¶„ë¥˜ì˜ ê·¼ê±°ë¥¼ ì–»ëŠ”ë‹¤.


## **ğŸ’¡í”„ë¡œì íŠ¸ ê°œìš”**
 ì½”ë¡œë‚˜ê°€ ë°œìƒìœ¼ë¡œ ì¸í•´ ì‹¤ë‚´ì™¸ì—ì„œ ë§ˆìŠ¤í¬ë¥¼ ì°©ìš©í•œ ì§€ 2ë…„ì´ ë„˜ìœ¼ë©° ë°©ì—­ ê¸°ì¡° ì „í™˜ìœ¼ë¡œ ì¸í•´ ì‹¤ì™¸ ì°©ìš© ì˜ë¬´ê°€ í•´ì œëì§€ë§Œ ë§ˆìŠ¤í¬ëŠ” ì—¬ì „íˆ ì‹¤ë‚´ë‚˜ ì‹¤ì™¸ ë‹¤ì¤‘ì´ìš©ì‹œì„¤ì—ì„œëŠ” ê¼­ ì°©ìš©í•´ì•¼ í•œë‹¤.
 
 
ì´ì™€ ê°™ì€ ë§ˆìŠ¤í¬ ì°©ìš© ì¥ê¸°í™”ëŠ” ì–´ë¦°ì´ë“¤ì˜ ì–¼êµ´ ì¸ì‹ ëŠ¥ë ¥ì— ë¶€ì •ì  ì˜í–¥ì„ ë¯¸ì¹œë‹¤ëŠ” ì—°êµ¬ê°€ ë°œí‘œë˜ê³  ìˆëŠ” ìƒí™©ì´ë‹¤. ë”°ë¼ì„œ ë³¸ í”„ë¡œì íŠ¸ëŠ” ì°¨í›„ ì–´ë¦°ì´ë“¤ì˜ ê°ì • ì´í•´ ë° í•™ìŠµì„ ë„ìš¸ ìˆ˜ ìˆëŠ” í•˜ë‚˜ì˜ ë°©ì•ˆìœ¼ë¡œì„œ **ì¸ê°„ì˜ ê°ì •ì„ íŒë‹¨í•  ìˆ˜ ìˆëŠ” í•™ìŠµëª¨ë¸**ì„ ë§Œë“œëŠ” ê²ƒì„ ëª©í‘œë¡œ í•œë‹¤. 


ìš°ì„  ê°€ì¥ ëŒ€í‘œì ì¸ ê°ì • 6ê°€ì§€(angry, disgust, happy, neutral, sad, surprise)ë¥¼ ì„ ì •í•˜ì—¬  [ë°ì´í„° ì…‹](#ë°ì´í„°ì…‹)ì„ êµ¬ì„±í•˜ì˜€ë‹¤. [ì˜¤í”ˆì†ŒìŠ¤ â€˜openfaceâ€™](https://github.com/TadasBaltrusaitis/OpenFace/wiki/Action-Units)ë¥¼ í™œìš©í•´ ë°ì´í„°ì…‹ì„ ë¶„ì„í•˜ì—¬ ê° ê°ì •ì˜ ì¢Œí‘œ ë° AUìŠ¤ì½”ì–´ jpgíŒŒì¼, csvíŒŒì¼ ë°ì´í„°ì…‹ì„ í™•ë³´í–ˆë‹¤. 6ê°€ì§€ ê°ì •ì„ ë¶„ë¥˜í•˜ëŠ” ë°©ë²•ì€ **ë‹¤ì¤‘ ë¡œì§€ìŠ¤í‹± íšŒê·€ ë°©ì‹**ì„ ì´ìš©í–ˆìœ¼ë©° **ì†ì„±ì€ AU_r, í´ë˜ìŠ¤ëŠ” 6ê°€ì§€ ê°ì •**ìœ¼ë¡œ ì •í–ˆë‹¤. 


 ë§ˆì§€ë§‰ìœ¼ë¡œ AUìŠ¤ì½”ì–´ë¥¼ í™œìš©í•œ [ë‹¤ì¤‘ë¡œì§€ìŠ¤í‹± íšŒê·€ ë°©ì‹ì˜ ëª¨ë¸](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/src/model.ipynb), êµ¬ê¸€ì—ì„œ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ì¸ [Teachable Machine í™œìš© ëª¨ë¸](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/src/Teachable_machine_model.ipynb), [CNN í™œìš© ëª¨ë¸](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/src/CNN_model.ipynb)(based [kaggle data_set](https://www.kaggle.com/datasets/msambare/fer2013))ì˜ ì„±ëŠ¥ì„ ë¹„êµí•´ë³¸ë‹¤.

## **ğŸ’¡ë²„ì „**
```
TensorFlow 2.9.2 
Python 3.8.13 ì´ìƒ
matplotlib 3.5.2
keras 2.9.0
```
## **ğŸ’¡ 1.ì˜¤í”ˆì†ŒìŠ¤ í™˜ê²½ ì„¤ì • ë° ë°ì´í„° ì¶”ì¶œ ë°©ë²•**
### 1) ì˜¤í”ˆì†ŒìŠ¤ í™˜ê²½ ì„¤ì •
1. Creat folder
- [creatFolder.py](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/src/creatFloder.py)ìœ¼ë¡œ OpenFace > input, output ìƒì„±

2. Docker download 
- [docker download](https://docs.docker.com/get-docker/) í›„ starting

3. Window powershell command ì»¤ë„ ì„¤ì¹˜
```
wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi
```
### 2) ë°ì´í„°ì…‹ ì¶”ì¶œ
ë°©ë²•1. window powershell command ì…ë ¥
docker ì‹¤í–‰ í›„ openface 
```
docker run -it --rm -d --name openface -v C:\OpenFace\input:/home/openface-build/build/bin/input -v C:\OpenFace\output:/home/openface-build/build/bin/processed -w /home/openface-build/build/bin algebr/openface:latest
```
input í•˜ìœ„ í´ë”ì˜ ë°ì´í„°ì…‹ ë¶„ì„
  > inputì˜ í•˜ìœ„ í´ë”ì— ë¶„ì„í•˜ê³ ìí•˜ëŠ” ë°ì´í„°(jpgí˜•ì‹ë§Œ ê°€ëŠ¥)ì €ì¥ 
```
docker exec openface ./FaceLandmarkImg -fdir input/[í´ë”ëª…] -out_dir processed/[í´ë”ëª…]
```
ë°©ë²•2. íŒŒì´ì¬ ì½”ë“œ ì…ë ¥
```
import os
# docker ì‹¤í–‰ í›„ openface ì‹¤í–‰ ëª…ë ì–´
os.system('docker run -it --rm -d --name openface -v C:\OpenFace\input:/home/openface-build/build/bin/input -v C:\OpenFace\output:/home/openface-build/build/bin/processed -w /home/openface-build/build/bin algebr/openface:latest')
# input í•˜ìœ„ í´ë” ë¶„ì„ > output í•˜ìœ„ í´ë” csv íŒŒì¼ ìƒì„± ëª…ë ¹ì–´
os.system('docker exec openface ./FaceLandmarkImg -fdir input/[í´ë”ëª…] -out_dir processed/[í´ë”ëª…]')
```
- ì‹¤í–‰ê²°ê³¼ :  [command.ipynb](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/src/command.ipynb)
> <img width="304" alt="hahahah" src="https://user-images.githubusercontent.com/101412264/186561481-37dda9e5-13ea-486e-8301-206c37307ba9.PNG">


## **ğŸ’¡ 2 .ìµœì¢… í•™ìŠµ ë°ì´í„° ìƒì„± ë° ëª¨ë¸ ì„¤ê³„ ë°©ë²•**
### 1) csvíŒŒì¼ í†µí•© í›„ au_r ìŠ¤ì½”ì–´ ì¶”ì¶œ > ìµœì¢… í•™ìŠµë°ì´í„° ìƒì„±
- ê° í´ë˜ìŠ¤ë³„ë¡œ ë°˜ë³µí•´ì„œ csvíŒŒì¼ ë§Œë“¤ê¸° > ê²°ê³¼: [/data/csv/angry.csv](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/data/csv/angry.csv),[/data/csv/disgust.csv](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/data/csv/disgust.csv),[/data/csv/happy.csv](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/data/csv/happy.csv),[/data/csv/neutral.csv](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/data/csv/nutral.csv), [/data/csv/sad.csv](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/data/csv/sad.csv),[/data/csv/surprise.csv](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/data/csv/surprise.csv)
```
import os
import pandas as pd

file_csv = []
def print_files_in_dir(root_dir):
    files = os.listdir(root_dir)
    for file in files:
        path = os.path.join(root_dir, file)
        file_name = path
        if file_name[-4:] =='.csv':
            file_csv.append(file_name)
 
if __name__ == "__main__":
    root_dir = r"C:\OpenFace\output\[ê° ê°ì • í´ë”ëª…]"
    print_files_in_dir(root_dir)

# csv íŒŒì¼ > dataframe ì½ê³  í†µí•©í•˜ê¸°
all_df = pd.DataFrame()
for path in file_csv:
    df = pd.read_csv(path)
    all_df = pd.concat([all_df,df],ignore_index=True)
```
**AU_r ìŠ¤ì½”ì–´(ì†ì„±) ì¶”ì¶œ ë° í´ë˜ìŠ¤(ê°ì •)ì¶”ê°€ & csvì €ì¥**
```
all_df_X = all_df.iloc[:,-35:-18]
all_df['emotion'] = # ì¶”ì¶œí•˜ëŠ” ê°ì • ë°ì´í„°ì— ë§ì¶°ì„œ ìˆ«ì ë„£ê¸° - angry : 0 , disgust : 1, happy : 2, neutral : 3, sad : 4, surprise:5
all_df.to_csv('emotion.csv')
```
- ì‹¤í–‰ê²°ê³¼ 
> ìœ„ì˜ ê³¼ì • ë°˜ë³µ í›„ ê° í´ë˜ìŠ¤ë³„csv íŒŒì¼ì„ ì „ë¶€ í•©ì³ì„œ **ìµœì¢… í•™ìŠµë°ì´í„°** [**emotion.csv**](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/data/csv/emotion.csv) ìƒì„±

### 2) í•™ìŠµ ì§„í–‰ : ë‹¤ì¤‘ ë¡œì§€ìŠ¤í‹± íšŒê·€ë¶„ì„ > ëª¨ë¸ ì„¤ê³„
í•™ìŠµí•  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ëœë¤ì¶”ì¶œ
```
df_pre = pd.read_csv('emotion.csv')

df_all = df_pre.sample(frac=1)
```
ì›-í•«ì½”ë”©
```
dataset = df_all.values

import tensorflow as tf
from sklearn.preprocessing import LabelEncoder

X = dataset[:,:-1].astype(float) # confidence ì œì™¸
Y = dataset[:,-1]
Y_encoded = tf.keras.utils.to_categorical(Y)
```
ë°ì´í„°ì…‹(emotion.csv)ì—ì„œ train,test ì„¤ì • 
```
X_train,X_test,Y_train,Y_test = train_test_split(X,Y_encoded,
                                                 test_size = 0.25)
```
ë”¥ëŸ¬ë‹ ëª¨ë¸ ê²°ì •í•˜ê¸° : relu ì™€ softmax ì‚¬ìš©
```
model = Sequential()
model.add(Dense(300,input_dim=17,activation="relu"))
model.add(Dense(200,activation="relu"))
model.add(Dense(100,activation="relu"))
model.add(Dense(50,activation="relu"))
model.add(Dense(6,activation="softmax"))
model.compile(loss='categorical_crossentropy',
              optimizer='adam',
              metrics=['accuracy'])
```
ìë™ ì¤‘ë‹¨ ì„¤ì • 
```
early_stopping_callback = EarlyStopping(monitor='val_loss',patience=7)
```
ëª¨ë¸ ì €ì¥ í´ë” ìƒì„± ë°  ì €ì¥ ì¡°ê±´ ì„¤ì •
```
MODEL_DIR = './model'
if not os.path.exists(MODEL_DIR):
  os.mkdir(MODEL_DIR)
# ëª¨ë¸ ì €ì¥ ì¡°ê±´ ì„¤ì •
modelpath = './model/{epoch:02d}-{val_loss:.4f}.hdf5'
checkpointer = ModelCheckpoint(filepath=modelpath,
                               monitor="val_loss",
                               verbose=1,
                               save_best_only=True)
```
ëª¨ë¸ ì‹¤í–‰í•˜ê¸° ë° ì €ì¥
```
history = model.fit(X_train,Y_train,
                    validation_split=0.33,
                    epochs=5000,
                    batch_size=50,
                    callbacks=[early_stopping_callback,checkpointer])
```


## **ğŸ’¡ëª¨ë¸ ì„±ëŠ¥** 
- Model : [best_model.hdf5](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/models/best_model.hdf5)
- loss : 0.4320
- val_loss : 0.7306
- accuracy : 0.8518
- val_accuracy : 0.7353
- last update : 22/08/24
- ì‹¤í—˜ ê²°ê³¼ : [model.ipynb](https://github.com/Happy-ryan/Face-Emotion-Recognition/blob/main/src/model.ipynb)

## **ğŸ’¡ëª¨ë¸ í…ŒìŠ¤íŠ¸**
1. ë°ì´í„° ìˆ˜ì— ë”°ë¥¸ ê° ê°ì •ë³„ ì •ë‹µë¥  íŒë‹¨
> model

> CNN

> Teachable machine
  

2. train_setì— í¬í•¨ë˜ì§€ ì•ŠëŠ” [60ì¥ì˜ test_set]()ì— ëŒ€í•œ ë‘ ê°€ì§€ ëª¨ë¸ ì •ë‹µë¥  ë¹„êµ
> AUìŠ¤ì½”ì–´ë¥¼ í™œìš©í•œ ë‹¤ì¤‘ë¡œì§€ìŠ¤í‹± íšŒê·€ ë°©ì‹ì˜ ëª¨ë¸
> ì •ë‹µë¥  :
> Teachable Machine í™œìš© ëª¨ë¸ 
> ì •ë‹µë¥  :
## **ë°ì´í„°ì…‹** 
ì´ 6ì¢… ì„ ì •
1. train_data
- angry 713ì¥
- disgust 220ì¥
- happy 766ì¥
- neutral 700ì¥
- sad 1039ì¥
- surprise 1041ì¥
2. test_data
- ê° ê°ì •ë³„ 10ì¥ì”© 60ì¥
